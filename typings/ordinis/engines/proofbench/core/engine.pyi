"""
This type stub file was generated by pyright.
"""

import pandas as pd
from collections.abc import Callable
from datetime import datetime
from typing import Any
from ordinis.engines.base import BaseEngine, EngineMetrics, GovernanceHook
from ordinis.engines.proofbench.core.config import ProofBenchEngineConfig
from ordinis.engines.proofbench.core.execution import Order
from ordinis.engines.proofbench.core.models import TradeResult
from ordinis.engines.proofbench.core.simulator import SimulationResults

"""
ProofBench Backtesting Engine.

Standardized engine extending BaseEngine for backtesting operations.
Wraps SimulationEngine with governance hooks and lifecycle management.
"""
class ProofBenchEngine(BaseEngine[ProofBenchEngineConfig]):
    """Unified backtesting engine extending BaseEngine.

    Wraps SimulationEngine with standardized lifecycle management,
    governance hooks, and metrics tracking.

    Example:
        >>> from ordinis.engines.proofbench import (
        ...     ProofBenchEngine,
        ...     ProofBenchEngineConfig,
        ... )
        >>> config = ProofBenchEngineConfig(
        ...     initial_capital=100000.0,
        ...     enable_governance=True,
        ... )
        >>> engine = ProofBenchEngine(config)
        >>> await engine.initialize()
        >>> engine.load_data("AAPL", df)
        >>> engine.set_strategy(my_strategy)
        >>> results = await engine.run_backtest()
    """
    def __init__(self, config: ProofBenchEngineConfig | None = ..., governance_hook: GovernanceHook | None = ...) -> None:
        """Initialize the ProofBench engine.

        Args:
            config: Engine configuration (uses defaults if None)
            governance_hook: Optional governance hook for preflight/audit
        """
        ...
    
    def load_data(self, symbol: str, data: pd.DataFrame) -> None:
        """Load historical data for a symbol.

        Args:
            symbol: Stock symbol
            data: DataFrame with OHLCV columns and datetime index

        Raises:
            RuntimeError: If engine not initialized
            ValueError: If data format is invalid
        """
        ...
    
    def set_strategy(self, strategy_callback: Callable) -> None:
        """Set strategy callback function.

        The callback is called on each bar with (engine, symbol, bar).
        It should submit orders using engine.submit_order().

        Args:
            strategy_callback: Function to call on each bar

        Raises:
            RuntimeError: If engine not initialized
        """
        ...
    
    def submit_order(self, order: Order) -> None:
        """Submit an order for execution.

        Args:
            order: Order to submit

        Raises:
            RuntimeError: If engine not initialized
        """
        ...
    
    async def run_backtest(self, start: datetime | None = ..., end: datetime | None = ...) -> SimulationResults:
        """Run the backtest simulation.

        Includes governance preflight check if enabled.

        Args:
            start: Start date (uses data start if None)
            end: End date (uses data end if None)

        Returns:
            SimulationResults object
        """
        ...
    
    def get_position(self, symbol: str) -> Any:
        """Get current position for a symbol.

        Args:
            symbol: Stock symbol

        Returns:
            Position object or None
        """
        ...
    
    def get_cash(self) -> float:
        """Get current cash balance.

        Returns:
            Cash balance
        """
        ...
    
    def get_equity(self) -> float:
        """Get current total equity.

        Returns:
            Total equity
        """
        ...
    
    def get_last_results(self) -> SimulationResults | None:
        """Get results from last backtest.

        Returns:
            Last SimulationResults or None
        """
        ...
    
    @property
    def backtests_run(self) -> int:
        """Public accessor for the number of backtests run (read-only)."""
        ...
    
    def get_metrics(self) -> EngineMetrics:
        """Get ProofBench engine metrics.

        Returns:
            Current engine metrics including backtest-specific stats
        """
        ...
    
    @property
    def trade_history(self) -> list[TradeResult]:
        """Get recorded trade history.

        Returns:
            List of TradeResult objects
        """
        ...
    
    async def record(self, trade_results: list[dict[str, Any]]) -> None:
        """Record trade results for analytics.

        Args:
            trade_results: List of trade result dictionaries with keys:
                symbol, side, quantity, price, timestamp, order_id, pnl (optional), fees (optional)
        """
        ...
    
    def calculate_metrics(self) -> dict[str, float]:
        """Calculate performance metrics from recorded trades.

        Returns:
            Dictionary with trade_count, total_pnl, win_rate, sharpe_ratio, max_drawdown
        """
        ...
    
    def get_performance_summary(self) -> dict[str, Any]:
        """Get a complete performance summary.

        Returns:
            Dictionary with all metrics plus timestamp
        """
        ...
    


