#!/usr/bin/env python3
"""
Visualization script for Massive Optimization results.

Reads the trials CSV generated by `run_massive_gpu_optimization.py` and produces
interactive Plotly visualizations.
"""

import argparse
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from plotly.subplots import make_subplots
from pathlib import Path

# Configure
ARTIFACTS_DIR = Path("artifacts/massive_optimization")

def generate_visuals(csv_path: str):
    print(f"Loading trials data from {csv_path}...")
    df = pd.read_csv(csv_path)
    
    # Filter for completed trials
    if 'state' in df.columns:
        df = df[df['state'] == 'COMPLETE']
    
    # Identify parameter columns (usually start with 'params_')
    param_cols = [c for c in df.columns if c.startswith('params_')]
    value_col = 'value'
    
    # Shorten param names for plotting
    short_names = {c: c.replace('params_', '') for c in param_cols}
    df = df.rename(columns=short_names)
    param_names = list(short_names.values())
    
    print(f"Found {len(df)} completed trials.")
    print(f"Parameters: {param_names}")
    
    # 1. Optimization History (Scatter)
    fig_hist = px.scatter(
        df, x='number', y=value_col, 
        title='Optimization History',
        labels={'number': 'Trial', value_col: 'Objective Value (PnL)'},
        trendline="lowess"
    )
    hist_path = ARTIFACTS_DIR / "viz_optimization_history.html"
    fig_hist.write_html(hist_path)
    fig_hist.write_image(hist_path.with_suffix(".png"))
    print(f"Saved {hist_path} and .png")

    # 2. Parallel Coordinates (High Dimensional)
    # Filter out top 50% for cleaner plot if too many points, or just plot all
    # Color by value
    fig_parcoords = px.parallel_coordinates(
        df, 
        dimensions=param_names + [value_col],
        color=value_col,
        title='Parallel Coordinates Plot',
        color_continuous_scale=px.colors.diverging.Tealrose,
    )
    par_path = ARTIFACTS_DIR / "viz_parallel_coordinates.html"
    fig_parcoords.write_html(par_path)
    fig_parcoords.write_image(par_path.with_suffix(".png"))
    print(f"Saved {par_path} and .png")
    
    # 3. Parameter Scatter Matrix (Slice Plot equivalent)
    # Select top 3 most important params (by simple correlation)
    corrs = df[param_names].corrwith(df[value_col]).abs().sort_values(ascending=False)
    top_params = corrs.head(4).index.tolist()
    
    fig_slice = px.scatter_matrix(
        df,
        dimensions=top_params,
        color=value_col,
        title=f'Slice Plot (Top Parameters: {", ".join(top_params)})'
    )
    slice_path = ARTIFACTS_DIR / "viz_slice_plot.html"
    fig_slice.write_html(slice_path)
    fig_slice.write_image(slice_path.with_suffix(".png"))
    print(f"Saved {slice_path} and .png")

    # 4. Contour Plot of Top 2 Params
    if len(top_params) >= 2:
        fig_contour = px.density_contour(
            df, 
            x=top_params[0], 
            y=top_params[1], 
            z=value_col, 
            histfunc="avg",
            title=f'Contour: {top_params[0]} vs {top_params[1]} (Avg Value)'
        )
        # Add scatter on top
        fig_contour.add_trace(
            go.Scatter(
                x=df[top_params[0]], 
                y=df[top_params[1]], 
                mode='markers', 
                marker=dict(color=df[value_col], showscale=True),
                text=df[value_col]
            )
        )
        contour_path = ARTIFACTS_DIR / "viz_contour_top2.html"
        fig_contour.write_html(contour_path)
        fig_contour.write_image(contour_path.with_suffix(".png"))
        print(f"Saved {contour_path} and .png")

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("csv_file", nargs='?', help="Path to trials CSV file")
    args = parser.parse_args()
    
    if args.csv_file:
        file_path = args.csv_file
    else:
        # Find latest
        files = list(ARTIFACTS_DIR.glob("massive_opt_trials_*.csv"))
        if not files:
            print("No trials CSV found in artifacts/massive_optimization/")
            exit(1)
        file_path = sorted(files)[-1]
        print(f"Auto-detected latest file: {file_path}")
        
    generate_visuals(file_path)
